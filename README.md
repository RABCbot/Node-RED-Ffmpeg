# Node-RED-Ffmpeg
Node-RED flow to execute FFmpeg transcoding

...
[{"id":"d40306d9.28c7e8","type":"exec","z":"2635a590.88b7ca","command":"ffmpeg","addpay":true,"append":"","useSpawn":"true","timer":"","oldrc":false,"name":"","x":910,"y":220,"wires":[["a2d0e8bb.47cc68"],["8f41363b.ed1ac8","a2d0e8bb.47cc68"],["1a46fd87.bc4402","a2d0e8bb.47cc68"]]},{"id":"1a46fd87.bc4402","type":"change","z":"2635a590.88b7ca","name":"done","rules":[{"t":"set","p":"complete","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":260,"wires":[["8f41363b.ed1ac8"]]},{"id":"8f41363b.ed1ac8","type":"join","z":"2635a590.88b7ca","name":"","mode":"custom","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1090,"y":220,"wires":[["f7524b17.895af8"]]},{"id":"39c590fd.104f3","type":"switch","z":"2635a590.88b7ca","name":"","property":"payload","propertyType":"msg","rules":[{"t":"regex","v":"(Stream.*Audio)","vt":"str","case":false},{"t":"regex","v":"(Stream.*Video)","vt":"str","case":false},{"t":"regex","v":"(Stream.*Subtitle)","vt":"str","case":false},{"t":"cont","v":"NUMBER_OF_FRAMES:","vt":"str"},{"t":"cont","v":"Duration","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":210,"y":400,"wires":[["2b64bb1b.9ebe04"],["84f5f937.2422d8"],["e8f4d6bf.e38308"],["91fda19e.85e7f"],["28229ce5.c991c4"]]},{"id":"f7524b17.895af8","type":"split","z":"2635a590.88b7ca","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":90,"y":400,"wires":[["39c590fd.104f3","1f356565.62ef5b"]]},{"id":"a934e2d8.9c279","type":"switch","z":"2635a590.88b7ca","name":"stereo","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"stereo","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":320,"wires":[["f6335c01.182c7"],["6b299d1f.45b604"]]},{"id":"f65f778f.82d888","type":"function","z":"2635a590.88b7ca","name":"-i","func":"return {payload: \"-i \" + \"/home/admin/local/inbound/\" + flow.get(\"filename\")};","outputs":1,"noerr":0,"x":790,"y":220,"wires":[["d40306d9.28c7e8","a2d0e8bb.47cc68"]]},{"id":"eae8ab60.4ee018","type":"exec","z":"2635a590.88b7ca","command":"ffmpeg","addpay":true,"append":"","useSpawn":"true","timer":"","oldrc":false,"name":"","x":270,"y":640,"wires":[[],["1abf2686.71aa39"],["ce9772f8.1d8ad","1abf2686.71aa39"]]},{"id":"1abf2686.71aa39","type":"switch","z":"2635a590.88b7ca","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"frame=","vt":"str"},{"t":"cont","v":"Error","vt":"str"},{"t":"cont","v":"Invalid","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":390,"y":620,"wires":[["cbc2749.c848a88"],["7214cc0c.982c34"],["7214cc0c.982c34"]]},{"id":"cbc2749.c848a88","type":"function","z":"2635a590.88b7ca","name":"get frame","func":"var o = msg.payload.indexOf(\"fps=\") - 1;\no = msg.payload.substring(6, o).trim();\nvar frames = flow.get(\"video-frames\");\nif (flow.get(\"extension\") == \"srt\")\n{\n    frames = flow.get(\"subtitle-frames\");\n}\nflow.set(\"progress\", o);\nreturn {payload: Math.floor(1000 * o / frames) / 10, topic: o};","outputs":1,"noerr":0,"x":540,"y":600,"wires":[["825c7830.13ed98","6ae00fe6.a615e"]]},{"id":"825c7830.13ed98","type":"ui_gauge","z":"2635a590.88b7ca","name":"","group":"f59d49ed.bfef38","order":0,"width":0,"height":0,"gtype":"donut","title":"","label":"%","format":"{{value}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":710,"y":580,"wires":[]},{"id":"7899cdc9.5e0584","type":"function","z":"2635a590.88b7ca","name":"file","func":"if (flow.get(\"progress\") > 0)\n{\n    flow.set(\"filename\", \"\");\n    flow.set(\"extension\", \"\");\n}\nelse\n{\n    flow.set(\"extension\", msg.payload.split(\".\").pop());\n    flow.set(\"filename\", msg.payload.replace(\".srt\", \".mkv\"));\n    \n}\n\nreturn {payload: flow.get(\"filename\")};","outputs":1,"noerr":0,"x":490,"y":220,"wires":[["7c23a351.1abe2c"]]},{"id":"cc9a33aa.9003","type":"switch","z":"2635a590.88b7ca","name":"h264","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"h264","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":360,"wires":[["7760db5c.01ba04"],["37999b4e.4c09e4"]]},{"id":"37999b4e.4c09e4","type":"change","z":"2635a590.88b7ca","name":"to libx264","rules":[{"t":"set","p":"payload","pt":"msg","to":"-c:v libx264 -preset slow -crf 22","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":420,"wires":[["6b95bcb1.543244"]]},{"id":"6b299d1f.45b604","type":"change","z":"2635a590.88b7ca","name":"to stereo","rules":[{"t":"set","p":"payload","pt":"msg","to":"-ac 2 -af \"pan=stereo|FL=FC+0.30*FL+0.30*BL|FR=FC+0.30*FR+0.30*BR\"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":340,"wires":[["6b95bcb1.543244"]]},{"id":"7760db5c.01ba04","type":"change","z":"2635a590.88b7ca","name":"v copy","rules":[{"t":"set","p":"payload","pt":"msg","to":"-c:v copy","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":380,"wires":[["6b95bcb1.543244"]]},{"id":"f6335c01.182c7","type":"change","z":"2635a590.88b7ca","name":"a copy","rules":[{"t":"set","p":"payload","pt":"msg","to":"-c:a copy","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":300,"wires":[["6b95bcb1.543244"]]},{"id":"6b95bcb1.543244","type":"join","z":"2635a590.88b7ca","name":"","mode":"custom","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":" ","joinerType":"str","accumulate":false,"timeout":"","count":"3","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":950,"y":380,"wires":[["f3e4a497.79d6a8"]]},{"id":"8e12eb09.5f08d8","type":"function","z":"2635a590.88b7ca","name":"i/o","func":"return {payload: \"-i \" + \"/home/admin/local/inbound/\" + flow.get(\"filename\") + \" \" + msg.payload + \" -y /home/admin/local/movies/\" + flow.get(\"filename\")};","outputs":1,"noerr":0,"x":1210,"y":400,"wires":[["a2d0e8bb.47cc68"]]},{"id":"b12d2fd.9859dd","type":"function","z":"2635a590.88b7ca","name":"-i srt","func":"var newMsg = {payload: \"-i /home/admin/local/inbound/\" + flow.get(\"filename\").replace(\"mkv\", \"srt\") + \" \" + msg.payload.replace(\"ENCODING\", flow.get(\"encoding\"))};\nreturn newMsg;","outputs":1,"noerr":0,"x":1070,"y":420,"wires":[["8e12eb09.5f08d8"]]},{"id":"4c266b26.e15d44","type":"fs-ops-move","z":"2635a590.88b7ca","name":"move","sourcePath":"/home/admin/local/movies/","sourcePathType":"str","sourceFilename":"payload","sourceFilenameType":"msg","destPath":"/home/admin/local/inbound/","destPathType":"str","destFilename":"payload","destFilenameType":"msg","link":false,"x":710,"y":260,"wires":[["f65f778f.82d888"]]},{"id":"b254b538.5e4748","type":"change","z":"2635a590.88b7ca","name":"-c:s","rules":[{"t":"set","p":"payload","pt":"msg","to":"-sub_charenc ENCODING -map 0:v -map 0:a -c copy -map 1 -c:s:0 srt -metadata:s:s:0 language=spa","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":950,"y":420,"wires":[["b12d2fd.9859dd"]]},{"id":"e07622f7.3ba27","type":"ui_text","z":"2635a590.88b7ca","group":"4f5ce843.3e6898","order":3,"width":0,"height":0,"name":"","label":"Status","format":"{{msg.payload}}","layout":"row-spread","x":550,"y":140,"wires":[]},{"id":"17631676.91206a","type":"link in","z":"2635a590.88b7ca","name":"inError","links":["7214cc0c.982c34","7f64be2c.a5b98","b2cd792a.3674e8","2c4399eb.c8d576"],"x":475,"y":120,"wires":[["e07622f7.3ba27"]]},{"id":"7214cc0c.982c34","type":"link out","z":"2635a590.88b7ca","name":"","links":["17631676.91206a"],"x":495,"y":640,"wires":[]},{"id":"91fda19e.85e7f","type":"function","z":"2635a590.88b7ca","name":"frames","func":"var i = msg.payload.indexOf(\"NUMBER_OF_FRAMES:\");\nvar o =  msg.payload.substr(i+17, 8).trim();\nflow.set(flow.get(\"stream\") + \"-frames\", o);\nreturn {payload: o};","outputs":1,"noerr":0,"x":410,"y":440,"wires":[[]]},{"id":"acd49161.041a9","type":"function","z":"2635a590.88b7ca","name":"Flow set","func":"flow.set(\"encoding\", msg.payload)\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":80,"wires":[[]]},{"id":"90bab48.21a4a48","type":"ui_text_input","z":"2635a590.88b7ca","name":"","label":"Sub Encoding","group":"4f5ce843.3e6898","order":1,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","x":120,"y":80,"wires":[["acd49161.041a9"]]},{"id":"2382be62.6631d2","type":"fs-ops-dir","z":"2635a590.88b7ca","name":"dir","path":"/home/admin/local/inbound","pathType":"str","filter":"*.*","filterType":"str","dir":"payload","dirType":"msg","x":250,"y":220,"wires":[["18854dc4.be1522"]]},{"id":"7c23a351.1abe2c","type":"switch","z":"2635a590.88b7ca","name":"ext","property":"extension","propertyType":"flow","rules":[{"t":"eq","v":"mkv","vt":"str"},{"t":"eq","v":"srt","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":610,"y":220,"wires":[["f65f778f.82d888"],["4c266b26.e15d44"],[]]},{"id":"5e19c9c8.477b18","type":"inject","z":"2635a590.88b7ca","name":"onStart","topic":"","payload":"","payloadType":"num","repeat":"","crontab":"","once":true,"onceDelay":"1","x":100,"y":140,"wires":[["1f240add.70be25"]]},{"id":"1f240add.70be25","type":"function","z":"2635a590.88b7ca","name":"init","func":"flow.set(\"progress\", 0);\nflow.set(\"filename\", \"\");\nflow.set(\"audio\", \"\");\nflow.set(\"video\", \"\");\nflow.set(\"subtitle\", \"\");\nflow.set(\"audio-frames\", 0);\nflow.set(\"video-frames\", 0);\nflow.set(\"subtitle-frames\", 0);\nreturn {payload: 0};","outputs":1,"noerr":0,"x":230,"y":140,"wires":[["af33a033.c645d","e07622f7.3ba27"]]},{"id":"af33a033.c645d","type":"link out","z":"2635a590.88b7ca","name":"outInit","links":["ee921e7c.d144","158ddf6b.2ac021"],"x":315,"y":160,"wires":[]},{"id":"ee921e7c.d144","type":"link in","z":"2635a590.88b7ca","name":"inDonut","links":["af33a033.c645d"],"x":615,"y":560,"wires":[["825c7830.13ed98","6ae00fe6.a615e"]]},{"id":"ce9772f8.1d8ad","type":"json","z":"2635a590.88b7ca","name":"","property":"payload","action":"obj","pretty":false,"x":390,"y":680,"wires":[["a249ed15.20376"]]},{"id":"a249ed15.20376","type":"switch","z":"2635a590.88b7ca","name":"rc","property":"payload.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":510,"y":680,"wires":[["e16804b6.3d8af8"],["7f64be2c.a5b98","97c2f634.3bd488"]]},{"id":"76a91c3b.f1a584","type":"fs-ops-delete","z":"2635a590.88b7ca","name":"Delete","path":"topic","pathType":"msg","filename":"payload","filenameType":"msg","x":770,"y":660,"wires":[["42708d94.e09d24"]]},{"id":"e16804b6.3d8af8","type":"function","z":"2635a590.88b7ca","name":"file","func":"return {\n    payload: flow.get(\"filename\"),\n    topic: \"/home/admin/local/inbound/\"\n};","outputs":1,"noerr":0,"x":650,"y":660,"wires":[["76a91c3b.f1a584"]]},{"id":"7f64be2c.a5b98","type":"link out","z":"2635a590.88b7ca","name":"","links":["17631676.91206a"],"x":615,"y":740,"wires":[]},{"id":"2b64bb1b.9ebe04","type":"function","z":"2635a590.88b7ca","name":"audio","func":"flow.set(\"stream\", \"audio\");\nvar a = msg.payload.split(\",\")[2].trim();\nflow.set(\"audio\", a);\nvar o = {payload: a}\nreturn o;","outputs":1,"noerr":0,"x":410,"y":320,"wires":[["a934e2d8.9c279","bbc1bf74.227f6"]]},{"id":"84f5f937.2422d8","type":"function","z":"2635a590.88b7ca","name":"video","func":"flow.set(\"stream\", \"video\");\nvar v = msg.payload.split(\":\")[3].split(\" \")[1];\nflow.set(\"video\", v);\nvar f = msg.payload.split(\",\")[3].split(\" \")[1];\nflow.set(\"fps\", f);\nvar o = {payload: v, topic: f};\nreturn o;","outputs":1,"noerr":0,"x":410,"y":360,"wires":[["cc9a33aa.9003","bb17c2f4.c78"]]},{"id":"e8f4d6bf.e38308","type":"function","z":"2635a590.88b7ca","name":"sub","func":"flow.set(\"stream\", \"subtitle\");\nvar s = msg.payload.split(\"\\(\")[1].split(\"\\)\")[0];\nvar o = {payload: s};\nflow.set(\"subtitle\", s);\nreturn o;","outputs":1,"noerr":0,"x":410,"y":400,"wires":[["d0d546aa.079628"]]},{"id":"f3e4a497.79d6a8","type":"switch","z":"2635a590.88b7ca","name":"ext","property":"extension","propertyType":"flow","rules":[{"t":"eq","v":"mkv","vt":"str"},{"t":"eq","v":"srt","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1070,"y":380,"wires":[["8e12eb09.5f08d8"],["b254b538.5e4748"]]},{"id":"42708d94.e09d24","type":"switch","z":"2635a590.88b7ca","name":"ext","property":"extension","propertyType":"flow","rules":[{"t":"eq","v":"srt","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":890,"y":660,"wires":[["12b7b927.3a8fd7"]]},{"id":"1b38e4dd.e159db","type":"fs-ops-delete","z":"2635a590.88b7ca","name":"Delete","path":"topic","pathType":"msg","filename":"payload","filenameType":"msg","x":1130,"y":660,"wires":[[]]},{"id":"12b7b927.3a8fd7","type":"function","z":"2635a590.88b7ca","name":"file","func":"return {\n    payload: flow.get(\"filename\").replace(\"mkv\", \"srt\"),\n    topic: \"/home/admin/local/inbound/\"\n};","outputs":1,"noerr":0,"x":1010,"y":660,"wires":[["1b38e4dd.e159db"]]},{"id":"4a65ea6.f0bb114","type":"change","z":"2635a590.88b7ca","name":"null","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":500,"wires":[["6b95bcb1.543244"]]},{"id":"1f356565.62ef5b","type":"switch","z":"2635a590.88b7ca","name":"last","property":"parts.index","propertyType":"msg","rules":[{"t":"eq","v":"msg.parts.count - 1","vt":"jsonata"}],"checkall":"true","repair":false,"outputs":1,"x":150,"y":500,"wires":[["4a65ea6.f0bb114"]]},{"id":"18854dc4.be1522","type":"change","z":"2635a590.88b7ca","name":"grab","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":220,"wires":[["7899cdc9.5e0584","e07622f7.3ba27"]]},{"id":"97c2f634.3bd488","type":"function","z":"2635a590.88b7ca","name":"file","func":"return {\n    payload: flow.get(\"filename\")\n};","outputs":1,"noerr":0,"x":650,"y":700,"wires":[["ded2a68c.c76888"]]},{"id":"f9b95f2a.bd27b","type":"switch","z":"2635a590.88b7ca","name":"ext","property":"extension","propertyType":"flow","rules":[{"t":"eq","v":"srt","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1010,"y":700,"wires":[["85eee643.98ad38"]]},{"id":"ded2a68c.c76888","type":"fs-ops-move","z":"2635a590.88b7ca","name":"move","sourcePath":"/home/admin/local/inbound/","sourcePathType":"str","sourceFilename":"payload","sourceFilenameType":"msg","destPath":"/home/admin/local/failed/","destPathType":"str","destFilename":"payload","destFilenameType":"msg","link":false,"x":770,"y":700,"wires":[["f9b95f2a.bd27b"]]},{"id":"85eee643.98ad38","type":"function","z":"2635a590.88b7ca","name":"file","func":"return {\n    payload: flow.get(\"filename\").replace(\"mkv\", \"srt\")\n};","outputs":1,"noerr":0,"x":1130,"y":700,"wires":[["f175b095.a54ea"]]},{"id":"f175b095.a54ea","type":"fs-ops-move","z":"2635a590.88b7ca","name":"move","sourcePath":"/home/admin/local/inbound/","sourcePathType":"str","sourceFilename":"payload","sourceFilenameType":"msg","destPath":"/home/admin/local/failed/","destPathType":"str","destFilename":"payload","destFilenameType":"msg","link":false,"x":1250,"y":700,"wires":[[]]},{"id":"5a348471.dab19c","type":"ui_button","z":"2635a590.88b7ca","name":"","group":"4f5ce843.3e6898","order":2,"width":0,"height":0,"passthru":false,"label":"Start","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":90,"y":220,"wires":[["2382be62.6631d2"]]},{"id":"bbc1bf74.227f6","type":"ui_text","z":"2635a590.88b7ca","group":"4f5ce843.3e6898","order":4,"width":0,"height":0,"name":"","label":"audio","format":"{{msg.payload}}","layout":"row-spread","x":530,"y":320,"wires":[]},{"id":"bb17c2f4.c78","type":"ui_text","z":"2635a590.88b7ca","group":"4f5ce843.3e6898","order":5,"width":0,"height":0,"name":"","label":"video","format":"{{msg.payload}}","layout":"row-spread","x":530,"y":360,"wires":[]},{"id":"d0d546aa.079628","type":"ui_text","z":"2635a590.88b7ca","group":"4f5ce843.3e6898","order":6,"width":0,"height":0,"name":"","label":"sub","format":"{{msg.payload}}","layout":"row-spread","x":530,"y":400,"wires":[]},{"id":"158ddf6b.2ac021","type":"link in","z":"2635a590.88b7ca","name":"","links":["af33a033.c645d"],"x":435,"y":280,"wires":[["bbc1bf74.227f6","bb17c2f4.c78","d0d546aa.079628"]]},{"id":"6ae00fe6.a615e","type":"ui_text","z":"2635a590.88b7ca","group":"f59d49ed.bfef38","order":0,"width":0,"height":0,"name":"","label":"Frame:","format":"{{msg.topic}}","layout":"row-spread","x":720,"y":620,"wires":[]},{"id":"28229ce5.c991c4","type":"function","z":"2635a590.88b7ca","name":"dur","func":"var i = msg.payload.indexOf(\"Duration:\");\nvar o =  msg.payload.substr(i+10, 11);\nflow.set(\"duration\", o);\nreturn {payload: o};","outputs":1,"noerr":0,"x":410,"y":480,"wires":[["62f674f5.a193ec"]]},{"id":"62f674f5.a193ec","type":"ui_text","z":"2635a590.88b7ca","group":"4f5ce843.3e6898","order":6,"width":0,"height":0,"name":"","label":"dur","format":"{{msg.payload}}","layout":"row-spread","x":530,"y":480,"wires":[]},{"id":"a2d0e8bb.47cc68","type":"debug","z":"2635a590.88b7ca","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1170,"y":600,"wires":[]},{"id":"f59d49ed.bfef38","type":"ui_group","z":"","name":"Progress","tab":"60257d37.9ee7b4","order":2,"disp":true,"width":"6","collapse":false},{"id":"4f5ce843.3e6898","type":"ui_group","z":"","name":"Filename","tab":"60257d37.9ee7b4","order":1,"disp":true,"width":"10","collapse":false},{"id":"60257d37.9ee7b4","type":"ui_tab","z":"","name":"RPI2","icon":"dashboard"}]
...
